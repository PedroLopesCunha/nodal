<div data-controller="scroll-restoration">
<div class="d-flex justify-content-between align-items-center mb-3 mt-2">
  <h1 class="mb-0 h2"><%= current_organisation.name %></h1>

  <div class="d-flex align-items-center gap-3">
    <%# Desktop search bar (hidden on mobile) %>
    <div class="d-none d-lg-block">
      <%= form_with url: products_path(org_slug: params[:org_slug]), method: :get, local: true do %>
        <% Array(params[:categories]).each do |cat_id| %>
          <%= hidden_field_tag 'categories[]', cat_id %>
        <% end %>
        <% Array(params[:queries]).each do |q| %>
          <%= hidden_field_tag 'queries[]', q %>
        <% end %>
        <div class="search-minimal">
          <%= text_field_tag 'queries[]', nil, class: "form-control", placeholder: t('storefront.products.index.search_placeholder') %>
          <button type="submit" class="search-minimal-btn" aria-label="Search">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </div>
      <% end %>
    </div>

    <%# Mobile filter button (visible only on mobile) %>
    <button class="btn btn-outline-primary d-lg-none"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#categoryFilterOffcanvas"
            aria-controls="categoryFilterOffcanvas">
      <i class="fa-solid fa-filter me-2"></i><%= t('storefront.products.index.filters_button') %>
      <% active_filter_count = Array(params[:categories]).length + Array(params[:queries]).length %>
      <% if active_filter_count > 0 %>
        <span class="badge bg-primary ms-1"><%= active_filter_count %></span>
      <% end %>
    </button>
  </div>
</div>

<%# Breadcrumbs when filtering by category %>
<%= render 'storefront/shared/category_breadcrumbs', breadcrumbs: @breadcrumbs if @breadcrumbs.present? %>

<%# Applied filters breadbox %>
<%= render 'storefront/products/applied_filters', active_filters: @active_filters %>

<%# Mobile offcanvas sidebar %>
<div class="offcanvas offcanvas-start d-lg-none"
     tabindex="-1"
     id="categoryFilterOffcanvas"
     aria-labelledby="categoryFilterOffcanvasLabel">
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title" id="categoryFilterOffcanvasLabel">
      <i class="fa-solid fa-filter me-2"></i><%= t('storefront.products.index.filters_title') %>
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <%# Search %>
    <div class="mb-4">
      <h6 class="card-title mb-3"><%= t('storefront.products.index.search') %></h6>
      <%= form_with url: products_path(org_slug: params[:org_slug]), method: :get, local: true do %>
        <% Array(params[:categories]).each do |cat_id| %>
          <%= hidden_field_tag 'categories[]', cat_id %>
        <% end %>
        <% Array(params[:queries]).each do |q| %>
          <%= hidden_field_tag 'queries[]', q %>
        <% end %>
        <div class="sidebar-search">
          <%= text_field_tag 'queries[]', nil, class: "form-control", placeholder: t('storefront.products.index.search_placeholder') %>
          <button type="submit" class="sidebar-search-btn" aria-label="Search">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </div>
      <% end %>
    </div>

    <%# Categories %>
    <%= render 'storefront/shared/category_sidebar_content', categories: @categories, current_categories: @current_categories %>

    <%# Clear filters button %>
    <% if Array(params[:categories]).any? || Array(params[:queries]).any? %>
      <div class="mt-4 pt-3 border-top">
        <%= link_to products_path(org_slug: params[:org_slug]), class: "btn btn-outline-secondary w-100" do %>
          <i class="fa-solid fa-times me-2"></i><%= t('storefront.products.index.clear_filters') %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<%# Product count (aligned with product grid) %>
<% if @products.any? %>
  <div class="row mb-2">
    <div class="col-lg-9 offset-lg-3">
      <small class="text-muted">
        <%= t('storefront.products.index.showing_products',
              from: @pagy.from,
              to: @pagy.to,
              count: @pagy.count) %>
      </small>
    </div>
  </div>
<% end %>

<div class="row">
  <%# Desktop sidebar with filters (hidden on mobile) %>
  <div class="col-lg-3 mb-4 d-none d-lg-block">
    <%= render 'storefront/shared/category_sidebar', categories: @categories, current_categories: @current_categories %>
  </div>

  <%# Product grid %>
  <div class="col-lg-9">
    <% if @products.any? %>
      <div class="row row-cols-2 row-cols-md-2 row-cols-xl-3 product-grid">
        <% @products.each do |product| %>
          <div class="col">
            <%= link_to product_path(org_slug: params[:org_slug], id: product, categories: params[:categories], queries: params[:queries]), class: "text-decoration-none" do %>
              <div class="card h-100 product-card">
                <% discount_info = @product_discounts[product.id] %>
                <div class="product-card-image">
                  <% if product.photo_attached? %>
                    <%= image_tag product.photo, alt: product.name %>
                  <% else %>
                    <i class="fa-solid fa-image placeholder-icon"></i>
                  <% end %>
                </div>
                <div class="card-body">
                  <% if product.primary_category&.name.present? %>
                    <span class="product-card-category"><%= product.primary_category.name %></span>
                  <% end %>
                  <h5 class="product-card-title"><%= product.name %></h5>
                </div>
                <div class="card-footer">
                  <div class="d-flex justify-content-between align-items-center">
                    <% if discount_info && discount_info[:has_discount] %>
                      <div>
                        <span class="product-card-price-original">
                          <%= humanized_money_with_symbol(discount_info[:base_price]) %>
                        </span>
                        <span class="product-card-price-discounted">
                          <%= humanized_money_with_symbol(discount_info[:final_price]) %>
                        </span>
                        <span class="badge bg-success product-card-discount-badge">
                          -<%= (discount_info[:effective_discount][:percentage] * 100).round(0) %>%
                        </span>
                        <% if discount_info[:all_discounts].any? { |d| d[:type] == :product } %>
                          <span class="badge bg-danger product-card-sale-badge ms-1"><%= t('storefront.products.index.sale_badge') %></span>
                        <% end %>
                      </div>
                    <% elsif product.variable? %>
                      <span class="product-card-price"><%= product.display_price %></span>
                    <% else %>
                      <span class="product-card-price"><%= humanized_money_with_symbol(product.price) %></span>
                    <% end %>
                    <span class="product-card-unit"><%= product.unit_description %></span>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <%# Pagination controls %>
      <% if @pagy.pages > 1 %>
        <div class="d-flex justify-content-center mt-4">
          <%== pagy_bootstrap_nav(@pagy) %>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-5">
        <i class="fa-solid fa-box-open fa-4x text-muted mb-3"></i>
        <h4><%= t('storefront.products.index.no_products') %></h4>
        <p class="text-muted">
          <% if Array(params[:queries]).any? || Array(params[:categories]).any? %>
            <%= t('storefront.products.index.no_products_hint') %>
          <% else %>
            <%= t('storefront.products.index.empty_catalog') %>
          <% end %>
        </p>
      </div>
    <% end %>
  </div>
</div>

</div>
